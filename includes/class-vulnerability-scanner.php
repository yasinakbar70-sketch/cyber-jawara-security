<?php
/**
 * Class Jawara_Vulnerability_Scanner
 * Checks installed plugins and themes for known vulnerabilities
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

class Jawara_Vulnerability_Scanner {

	const API_ENDPOINT = 'https://www.wpscan.com/api/v3/'; // Placeholder, requires API key usually. 
	// For this implementation, we will use a simpler check against WP.org repository version
	// and flag outdated plugins as potential risks, as true vulnerability DB access often requires paid API keys.
	// We can also check against a local list of critical vulnerabilities if we maintain one.

	/**
	 * Run vulnerability scan
	 *
	 * @return array Scan results
	 */
	public static function scan() {
		if ( ! function_exists( 'get_plugins' ) ) {
			require_once ABSPATH . 'wp-admin/includes/plugin.php';
		}

		$results = array(
			'plugins' => array(),
			'themes' => array(),
			'core' => array(),
			'timestamp' => current_time( 'mysql' ),
		);

		// 1. Check Plugins
		$all_plugins = get_plugins();
		$update_plugins = get_site_transient( 'update_plugins' );

		foreach ( $all_plugins as $plugin_path => $plugin_data ) {
			$is_vulnerable = false;
			$vulnerabilities = array();

			// Check if update available
			$has_update = isset( $update_plugins->response[ $plugin_path ] );
			
			if ( $has_update ) {
				$vulnerabilities[] = 'Outdated version. Update available.';
			}

			// Simple check for known bad plugins (example list)
			$bad_plugins = array( 'wp-file-manager' => '6.8', 'contact-form-7' => '5.3.1' ); // Example versions
			// In a real scenario, this would query an API.
			
			// For now, we flag outdated plugins as "Medium" risk
			if ( $has_update ) {
				$results['plugins'][] = array(
					'name' => $plugin_data['Name'],
					'version' => $plugin_data['Version'],
					'latest_version' => $has_update ? $update_plugins->response[ $plugin_path ]->new_version : $plugin_data['Version'],
					'status' => 'warning',
					'issues' => $vulnerabilities,
				);
			}
		}

		// 2. Check Themes
		$all_themes = wp_get_themes();
		$update_themes = get_site_transient( 'update_themes' );

		foreach ( $all_themes as $theme_slug => $theme ) {
			$has_update = isset( $update_themes->response[ $theme_slug ] );

			if ( $has_update ) {
				$results['themes'][] = array(
					'name' => $theme->get( 'Name' ),
					'version' => $theme->get( 'Version' ),
					'latest_version' => $update_themes->response[ $theme_slug ]['new_version'],
					'status' => 'warning',
					'issues' => array( 'Outdated version. Update available.' ),
				);
			}
		}

		// 3. Check WordPress Core
		global $wp_version;
		$update_core = get_site_transient( 'update_core' );
		
		if ( $update_core && isset( $update_core->updates ) && ! empty( $update_core->updates ) ) {
			$latest_core = $update_core->updates[0];
			if ( $latest_core->response == 'upgrade' && version_compare( $wp_version, $latest_core->current, '<' ) ) {
				$results['core'] = array(
					'current_version' => $wp_version,
					'latest_version' => $latest_core->current,
					'status' => 'critical',
					'issues' => array( 'WordPress core is outdated. Security risk.' ),
				);
			}
		}

		return $results;
	}
}
