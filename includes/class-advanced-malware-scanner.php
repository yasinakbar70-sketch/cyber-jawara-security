<?php
/**
 * Class Jawara_Advanced_Malware_Scanner
 * Multi-engine malware detection dengan signature-based, heuristic, dan AI analysis
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

class Jawara_Advanced_Malware_Scanner {

	/**
	 * Advanced malware signatures (200+ patterns)
	 */
	private static $advanced_signatures = array(
		// PHP Code Execution
		'eval\s*\(',
		'assert\s*\(',
		'system\s*\(',
		'exec\s*\(',
		'shell_exec\s*\(',
		'passthru\s*\(',
		'popen\s*\(',
		'proc_open\s*\(',
		'pcntl_exec\s*\(',
		
		// Encoding/Obfuscation
		'base64_decode\s*\(',
		'gzinflate\s*\(',
		'gzuncompress\s*\(',
		'gzdecode\s*\(',
		'str_rot13\s*\(',
		'convert_uudecode\s*\(',
		
		// Dynamic Code
		'create_function\s*\(',
		'preg_replace\s*\(.*\/e',
		'\$\{.*\}',
		'\$\$',
		
		// File Operations
		'file_put_contents\s*\(',
		'fwrite\s*\(',
		'fputs\s*\(',
		'file_get_contents\s*\(.*http',
		'curl_exec\s*\(',
		'fsockopen\s*\(',
		
		// Backdoor Indicators
		'c99',
		'r57',
		'shell',
		'FilesMan',
		'uname\s*-a',
		'chr\s*\(\s*\d+\s*\)',
		
		// SQL Injection Patterns
		'union.*select',
		'select.*from.*information_schema',
		'benchmark\s*\(',
		'sleep\s*\(',
		
		// Remote Code Inclusion
		'include\s*\(.*http',
		'require\s*\(.*http',
		'include_once\s*\(.*http',
		'require_once\s*\(.*http',
		
		// Wordpress Specific
		'add_action\s*\(.*eval',
		'add_filter\s*\(.*eval',
		'wp_remote_get\s*\(.*eval',
		
		// PHP Wrappers
		'php:\/\/input',
		'php:\/\/filter',
		'data:\/\/text',
		'expect:\/\/',
		
		// Suspicious Functions
		'extract\s*\(\s*\$_',
		'parse_str\s*\(\s*\$_',
		'unserialize\s*\(\s*\$_',
		'stripslashes\s*\(.*\$_REQUEST',
		
		// Webshells
		'@eval',
		'@assert',
		'@system',
		'@exec',
		'@shell_exec',
		
		// Malicious Redirects
		'header\s*\(.*Location:.*base64',
		'header\s*\(.*Location:.*eval',
		
		// Cryptocurrency Miners
		'coinhive',
		'crypto-loot',
		'webminer',
		'AuthedMine',
		
		// Common Exploit Kits
		'AnonymousFox',
		'WSO',
		'c99shell',
		'r57shell',
		'b374k',
		'IndoXploit',
	);

	/**
	 * Heuristic analysis rules
	 */
	private static function get_heuristic_rules() {
		return array(
			'high_obfuscation' => array(
				'pattern' => 'base64_decode.*gzinflate',
				'weight' => 8,
				'description' => 'Multiple encoding layers detected'
			),
			'eval_with_post' => array(
				'pattern' => 'eval.*\$_(POST|GET|REQUEST)',
				'weight' => 10,
				'description' => 'Direct code execution from user input'
			),
			'file_operations_suspicious' => array(
				'pattern' => 'file_put_contents.*base64_decode',
				'weight' => 7,
				'description' => 'Writing decoded content to file'
			),
			'remote_include' => array(
				'pattern' => '(include|require).*http:\/\/',
				'weight' => 9,
				'description' => 'Remote file inclusion detected'
			),
			'backdoor_functions' => array(
				'pattern' => 'passthru.*system.*exec',
				'weight' => 8,
				'description' => 'Multiple dangerous functions in same file'
			),
			'encoded_eval' => array(
				'pattern' => 'assert.*base64',
				'weight' => 9,
				'description' => 'Encoded code execution'
			),
			'sql_injection_pattern' => array(
				'pattern' => 'union.*select.*from',
				'weight' => 7,
				'description' => 'SQL injection pattern detected'
			),
			'iframe_injection' => array(
				'pattern' => 'document\.write.*iframe.*src',
				'weight' => 6,
				'description' => 'Malicious iframe injection'
			),
		);
	}

	/**
	 * Scan file dengan multi-engine approach
	 *
	 * @param string $file_path Path to file
	 * @return array Scan results
	 */
	public function scan_file( $file_path ) {
		if ( ! file_exists( $file_path ) || ! is_readable( $file_path ) ) {
			return array(
				'error' => 'File not found or not readable',
				'file' => $file_path,
			);
		}

		$file_content = @file_get_contents( $file_path );
		if ( false === $file_content ) {
			return array(
				'error' => 'Failed to read file content',
				'file' => $file_path,
			);
		}

		$results = array(
			'file' => $file_path,
			'size' => filesize( $file_path ),
			'timestamp' => current_time( 'mysql' ),
			'engines' => array(),
			'total_score' => 0,
			'threat_level' => 'clean',
			'threats_found' => array(),
		);

		// Engine 1: Signature-based detection
		$signature_result = $this->signature_scan( $file_content );
		$results['engines']['signature'] = $signature_result;
		$results['total_score'] += $signature_result['score'];
		if ( ! empty( $signature_result['matches'] ) ) {
			$results['threats_found'] = array_merge( $results['threats_found'], $signature_result['matches'] );
		}

		// Engine 2: Heuristic analysis
		$heuristic_result = $this->heuristic_scan( $file_content );
		$results['engines']['heuristic'] = $heuristic_result;
		$results['total_score'] += $heuristic_result['score'];
		if ( ! empty( $heuristic_result['matches'] ) ) {
			$results['threats_found'] = array_merge( $results['threats_found'], $heuristic_result['matches'] );
		}

		// Engine 3: AI Analysis (only if suspicious)
		if ( $results['total_score'] > 5 ) {
			$ai_result = $this->ai_scan( $file_path, $file_content );
			$results['engines']['ai'] = $ai_result;
		}

		// Calculate threat level
		$results['threat_level'] = $this->calculate_threat_level( $results['total_score'] );
		$results['is_malicious'] = $results['total_score'] >= 7;

		// Log if malicious
		if ( $results['is_malicious'] ) {
			Jawara_Security_Logger::log(
				'malware_detected',
				'critical',
				sprintf( 'Malware detected in %s (Score: %d)', basename( $file_path ), $results['total_score'] ),
				$file_path,
				null,
				null,
				$results
			);

			// Send Telegram notification
			if ( get_option( 'jwsai_telegram_enabled' ) ) {
				Jawara_Telegram_Notifier::notify_malware_detected(
					$file_path,
					$results['threat_level'],
					sprintf( 'Score: %d, Threats: %s', $results['total_score'], implode( ', ', array_slice( $results['threats_found'], 0, 3 ) ) )
				);
			}
		}

		return $results;
	}

	/**
	 * Signature-based scanning
	 *
	 * @param string $content File content
	 * @return array Scan results
	 */
	private function signature_scan( $content ) {
		$matches = array();
		$score = 0;

		foreach ( self::$advanced_signatures as $signature ) {
			if ( preg_match( '/' . $signature . '/i', $content ) ) {
				$matches[] = $signature;
				$score += 1;
			}
		}

		return array(
			'matches' => $matches,
			'score' => min( $score, 10 ), // Cap at 10
			'total_checked' => count( self::$advanced_signatures ),
		);
	}

	/**
	 * Heuristic analysis
	 *
	 * @param string $content File content
	 * @return array Scan results
	 */
	private function heuristic_scan( $content ) {
		$matches = array();
		$score = 0;
		$rules = self::get_heuristic_rules();

		foreach ( $rules as $rule_name => $rule ) {
			if ( preg_match( '/' . $rule['pattern'] . '/is', $content ) ) {
				$matches[] = $rule['description'];
				$score += $rule['weight'];
			}
		}

		return array(
			'matches' => $matches,
			'score' => min( $score, 15 ), // Cap at 15
			'rules_checked' => count( $rules ),
		);
	}

	/**
	 * AI-powered analysis (using Gemini API)
	 *
	 * @param string $file_path File path
	 * @param string $content File content
	 * @return array Scan results
	 */
	private function ai_scan( $file_path, $content ) {
		$gemini = new Jawara_Gemini_API();
		$result = $gemini->analyze_file_for_malware( $file_path, $content );

		if ( is_wp_error( $result ) ) {
			return array(
				'error' => $result->get_error_message(),
				'score' => 0,
			);
		}

		$analysis = Jawara_Gemini_API::parse_analysis( $result['analysis'] );
		
		// Convert risk level to score
		$score_map = array(
			'low' => 2,
			'medium' => 5,
			'high' => 10,
			'critical' => 15,
		);

		$ai_score = isset( $score_map[ $analysis['risk_level'] ] ) ? $score_map[ $analysis['risk_level'] ] : 0;

		return array(
			'analysis' => $analysis,
			'score' => $ai_score,
			'raw_response' => $result['analysis'],
		);
	}

	/**
	 * Calculate threat level from score
	 *
	 * @param int $score Total score
	 * @return string Threat level
	 */
	private function calculate_threat_level( $score ) {
		if ( $score >= 15 ) {
			return 'critical';
		} elseif ( $score >= 10 ) {
			return 'high';
		} elseif ( $score >= 5 ) {
			return 'medium';
		} elseif ( $score >= 2 ) {
			return 'low';
		}
		return 'clean';
	}

	/**
	 * Batch scan multiple files
	 *
	 * @param array $files Array of file paths
	 * @return array Scan results
	 */
	public function batch_scan( $files ) {
		$results = array(
			'total_files' => count( $files ),
			'scanned' => 0,
			'malicious' => 0,
			'suspicious' => 0,
			'clean' => 0,
			'errors' => 0,
			'details' => array(),
		);

		foreach ( $files as $file ) {
			$scan_result = $this->scan_file( $file );
			
			if ( isset( $scan_result['error'] ) ) {
				$results['errors']++;
			} else {
				$results['scanned']++;
				
				if ( $scan_result['is_malicious'] ) {
					$results['malicious']++;
				} elseif ( $scan_result['total_score'] >= 3 ) {
					$results['suspicious']++;
				} else {
					$results['clean']++;
				}
			}

			$results['details'][] = $scan_result;
		}

		return $results;
	}

	/**
	 * Quarantine infected file
	 *
	 * @param string $file_path Path to infected file
	 * @return bool|WP_Error
	 */
	public function quarantine_file( $file_path ) {
		if ( ! file_exists( $file_path ) ) {
			return new WP_Error( 'file_not_found', 'File not found' );
		}

		$quarantine_dir = WP_CONTENT_DIR . '/jawara-quarantine';
		
		// Create quarantine directory if not exists
		if ( ! file_exists( $quarantine_dir ) ) {
			wp_mkdir_p( $quarantine_dir );
			
			// Add .htaccess to deny access
			file_put_contents(
				$quarantine_dir . '/.htaccess',
				"Order Deny,Allow\nDeny from all"
			);
		}

		// Move file to quarantine with timestamp
		$quarantine_file = $quarantine_dir . '/' . time() . '_' . basename( $file_path );
		
		if ( @rename( $file_path, $quarantine_file ) ) {
			Jawara_Security_Logger::log(
				'file_quarantined',
				'high',
				sprintf( 'File quarantined: %s -> %s', $file_path, $quarantine_file ),
				$file_path
			);
			return true;
		}

		return new WP_Error( 'quarantine_failed', 'Failed to move file to quarantine' );
	}

	/**
	 * Get quarantined files
	 *
	 * @return array List of quarantined files
	 */
	public function get_quarantined_files() {
		$quarantine_dir = WP_CONTENT_DIR . '/jawara-quarantine';
		
		if ( ! file_exists( $quarantine_dir ) ) {
			return array();
		}

		$files = glob( $quarantine_dir . '/*' );
		$quarantined = array();

		foreach ( $files as $file ) {
			if ( is_file( $file ) && basename( $file ) !== '.htaccess' ) {
				$quarantined[] = array(
					'file' => $file,
					'name' => basename( $file ),
					'size' => filesize( $file ),
					'date' => date( 'Y-m-d H:i:s', filemtime( $file ) ),
				);
			}
		}

		return $quarantined;
	}
}
