<?php
/**
 * Class Jawara_Malware_Detector
 * Mengelola malware signature scanning dan deteksi pattern berbahaya
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

class Jawara_Malware_Detector {

	/**
	 * Pola berbahaya yang di-scan
	 */
	private $dangerous_patterns = array(
		'base64_decode',
		'eval(',
		'gzinflate(',
		'gzuncompress(',
		'rot13(',
		'preg_replace("/e"',
		'create_function(',
		'assert(',
		'system(',
		'exec(',
		'passthru(',
		'shell_exec(',
		'pcntl_exec(',
		'proc_open(',
		'popen(',
		'fopen(',
		'fscanf(',
		'fread(',
		'file_get_contents(',
		'include(',
		'require(',
		'require_once(',
		'include_once(',
		'dl(',
		'extension_loaded(',
		'function_exists(',
		'class_exists(',
		'method_exists(',
		'get_defined_functions(',
		'get_defined_vars(',
		'get_defined_constants(',
		'serialize(',
		'unserialize(',
		'extract(',
		'parse_str(',
		'register_globals',
		'auto_prepend_file',
		'auto_append_file',
		'allow_url_include',
		'allow_url_fopen',
		'data:text/plain;base64',
		'<?php @eval',
		'phpinfo()',
		'mysql_query(',
		'mysqli_query(',
		'$_REQUEST',
		'$_SERVER[HTTP_',
		'hexdec(',
		'pack(',
		'chr(',
		'sprintf(',
	);

	/**
	 * Scan semua file untuk signature berbahaya
	 *
	 * @return array
	 */
	public function scan_all_files() {
		$wp_content_dir = WP_CONTENT_DIR;
		$files          = $this->get_php_files( $wp_content_dir );
		$suspicious     = array();

		foreach ( $files as $file ) {
			$suspicious_patterns = $this->scan_file( $file );

			if ( ! empty( $suspicious_patterns ) ) {
				$suspicious[] = array(
					'file'     => $file,
					'patterns' => $suspicious_patterns,
				);

				// Log dan analisis dengan AI
				$this->analyze_suspicious_file( $file, $suspicious_patterns );
			}
		}

		return $suspicious;
	}

	/**
	 * Scan satu file untuk pattern berbahaya
	 *
	 * @param string $file_path Path ke file
	 * @return array
	 */
	public function scan_file( $file_path ) {
		if ( ! file_exists( $file_path ) ) {
			return array();
		}

		$content = file_get_contents( $file_path );

		if ( false === $content ) {
			return array();
		}

		$found_patterns = array();

		foreach ( $this->dangerous_patterns as $pattern ) {
			if ( stripos( $content, $pattern ) !== false ) {
				$found_patterns[] = $pattern;
			}
		}

		return $found_patterns;
	}

	/**
	 * Analisis file yang mencurigakan dengan AI
	 *
	 * @param string $file_path Path ke file
	 * @param array $patterns Patterns yang ditemukan
	 */
	private function analyze_suspicious_file( $file_path, $patterns ) {
		$file_content = file_get_contents( $file_path );

		if ( false === $file_content ) {
			return;
		}

		// Log awal
		Jawara_Security_Logger::log(
			'malware_signature',
			'medium',
			"Suspicious patterns found: " . implode( ', ', $patterns ),
			$file_path
		);

		// Analisis dengan Gemini AI
		$gemini = new Jawara_Gemini_API();
		$result = $gemini->analyze_file_for_malware( $file_path, $file_content );

		if ( is_wp_error( $result ) ) {
			Jawara_Security_Logger::log(
				'malware_signature',
				'low',
				"AI analysis failed: " . $result->get_error_message(),
				$file_path
			);
			return;
		}

		$analysis = Jawara_Gemini_API::parse_analysis( $result['analysis'] );

		// Tentukan severity
		if ( 'yes' === $analysis['malicious'] ) {
			$severity = 'critical';
		} elseif ( 'high' === $analysis['risk_level'] ) {
			$severity = 'high';
		} elseif ( 'medium' === $analysis['risk_level'] ) {
			$severity = 'medium';
		} else {
			$severity = 'low';
		}

		// Log hasil analisis
		Jawara_Security_Logger::log(
			'malware_signature',
			$severity,
			"AI Analysis: " . $result['analysis'],
			$file_path,
			null,
			null,
			$analysis
		);

		// Kirim notifikasi
		if ( 'yes' === $analysis['malicious'] || 'high' === $analysis['risk_level'] ) {
			Jawara_Telegram_Notifier::notify_malware_detected(
				$file_path,
				$analysis['risk_level'],
				$result['analysis']
			);
		}
	}

	/**
	 * Get semua file PHP
	 *
	 * @param string $dir Direktori
	 * @return array
	 */
	private function get_php_files( $dir ) {
		$files = array();

		if ( ! is_dir( $dir ) ) {
			return $files;
		}

		try {
			$iterator = new RecursiveIteratorIterator(
				new RecursiveDirectoryIterator( $dir, RecursiveDirectoryIterator::SKIP_DOTS ),
				RecursiveIteratorIterator::SELF_FIRST
			);

			foreach ( $iterator as $file ) {
				if ( $file->isFile() && $file->getExtension() === 'php' ) {
					$path = $file->getPathname();

					if ( $this->should_skip_file( $path ) ) {
						continue;
					}

					$files[] = $path;
				}
			}
		} catch ( Exception $e ) {
			// Skip directories yang tidak bisa diakses
		}

		return $files;
	}

	/**
	 * Check apakah file harus di-skip
	 *
	 * @param string $file_path Path file
	 * @return bool
	 */
	private function should_skip_file( $file_path ) {
		$skip_patterns = array(
			'/node_modules/',
			'/vendor/',
			'/.git/',
			'/tmp/',
		);

		foreach ( $skip_patterns as $pattern ) {
			if ( strpos( $file_path, $pattern ) !== false ) {
				return true;
			}
		}

		return false;
	}
}
